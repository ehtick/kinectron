<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinectron Stream Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        #defaultCanvas0 {
            border: 1px solid #ccc;
        }

        #stats {
            margin-top: 10px;
            font-size: 14px;
        }

        .stat-item {
            margin: 5px 0;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>
</head>

<body>
    <div id="controls">
        <button onclick="initializeKinect()">Initialize Kinect</button>
        <button onclick="startColorStream()" disabled id="startColorBtn">Start Color Stream</button>
        <button onclick="startDepthStream()" disabled id="startDepthBtn">Start Depth Stream</button>
        <button onclick="stopStream()" disabled id="stopStreamBtn">Stop Stream</button>
    </div>
    <div id="canvas-container"></div>
    <div id="stats">
        <div id="connectionStatus" class="stat-item">Connection Status: Disconnected</div>
        <div id="streamStatus" class="stat-item">Stream Status: Inactive</div>
        <div id="frameRate" class="stat-item">Frame Rate: 0 fps</div>
        <div id="resolution" class="stat-item">Resolution: -</div>
    </div>

    <!-- Debug Panel -->
    <div id="debugPanel" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px; background-color: #f5f5f5;">
        <h3>Debug Panel</h3>
        <div id="debugInfo"></div>
        <div>
            <button onclick="forceEnableButtons()">Force Enable Buttons</button>
            <button onclick="clearDebugInfo()">Clear Debug Info</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <script type="module">
        import { Kinectron } from './src/kinectron-modern.js';
        window.Kinectron = Kinectron;
    </script>
    <script>
        // Constants
        const AZURE_COLOR_WIDTH = 1280;
        const AZURE_COLOR_HEIGHT = 720;
        const AZURE_DEPTH_WIDTH = 640;
        const AZURE_DEPTH_HEIGHT = 576;
        const DISPLAY_SCALE = 0.5;

        // Global variables
        let kinectron = null;
        let frameCount = 0;
        let lastFrameTime = 0;
        let frameRates = [];
        let lastFrameTimestamp = 0;
        let frameLatencies = [];
        let isStreamActive = false;

        function setup() {
            // Create canvas
            const canvas = createCanvas(AZURE_COLOR_WIDTH * DISPLAY_SCALE, AZURE_COLOR_HEIGHT * DISPLAY_SCALE);
            canvas.parent('canvas-container');
            pixelDensity(1);
            background(255);

            // Initialize Kinectron
            kinectron = new Kinectron({
                host: '127.0.0.1',
                port: 9001,
                path: '/'
            });

            // Connection status handling
            kinectron.on('ready', () => {
                document.getElementById('connectionStatus').innerHTML =
                    '<span class="success">Connection Status: Connected</span>';
                addDebugInfo('Peer connection ready');
            });

            kinectron.on('error', (error) => {
                document.getElementById('connectionStatus').innerHTML =
                    `<span class="error">Connection Status: Error - ${error.error || error.message}</span>`;
                console.error('Connection error:', error);
                addDebugInfo(`Connection error: ${error.error || error.message}`);
            });

            // Direct event listener for kinectInitialized as a backup approach
            kinectron.on('kinectInitialized', (data) => {
                addDebugInfo(`Direct kinectInitialized event received: ${JSON.stringify(data)}`);

                // Log button states before update
                const startBtnBefore = document.getElementById('startColorBtn').disabled;
                const stopBtnBefore = document.getElementById('stopStreamBtn').disabled;
                addDebugInfo(`Button states before: startColorBtn=${startBtnBefore}, stopStreamBtn=${stopBtnBefore}`);

                // Normalize the success value to handle nested structure
                let isSuccess = false;
                if (data.success && typeof data.success === 'object' && data.success.success === true) {
                    isSuccess = true;
                } else if (typeof data.success === 'boolean' && data.success === true) {
                    isSuccess = true;
                }

                // Enable buttons if successful
                if (isSuccess || data.alreadyInitialized) {
                    document.getElementById('startColorBtn').disabled = false;
                    document.getElementById('startDepthBtn').disabled = false;
                    document.getElementById('stopStreamBtn').disabled = false;
                    document.getElementById('streamStatus').innerHTML =
                        '<span class="success">Kinect Initialized via Direct Event</span>';
                    addDebugInfo('Kinect initialized successfully via direct event');
                } else {
                    addDebugInfo(`Kinect initialization had issues: ${data.error || 'Unknown error'}`);
                }

                // Log button states after update
                const startBtnAfter = document.getElementById('startColorBtn').disabled;
                const stopBtnAfter = document.getElementById('stopStreamBtn').disabled;
                addDebugInfo(`Button states after: startColorBtn=${startBtnAfter}, stopStreamBtn=${stopBtnAfter}`);
            });

            // Add a data event listener to capture all peer messages
            kinectron.on('data', (data) => {
                addDebugInfo(`Raw data event received: ${JSON.stringify(data)}`);
            });

            // Connect to server
            kinectron.peer.connect();

            // Start frame rate calculation
            setInterval(calculateMetrics, 1000);
        }

        function draw() {
            // Update frame rate display from p5.js
            const p5FrameRate = frameRate().toFixed(0);
            document.getElementById('frameRate').textContent =
                `Frame Rate: ${p5FrameRate} fps (p5.js) / ${calculateAverageFrameRate().toFixed(1)} fps (actual)`;

            // Draw frame count in corner if stream is active
            if (isStreamActive) {
                fill(0);
                textSize(14);
                text(`Frames: ${frameCount}`, 10, 20);
            }
        }

        // Calculate metrics
        function calculateMetrics() {
            if (!isStreamActive) return;

            // Calculate average latency
            if (frameLatencies.length > 0) {
                const avgLatency = frameLatencies.reduce((a, b) => a + b, 0) / frameLatencies.length;
                document.getElementById('resolution').textContent =
                    `Resolution: ${width * 2}x${height * 2} (displayed at ${width}x${height}) | Avg Latency: ${avgLatency.toFixed(1)}ms`;

                // Reset latencies array
                frameLatencies = [];
            }
        }

        // Calculate average frame rate
        function calculateAverageFrameRate() {
            if (frameRates.length === 0) return 0;
            return frameRates.reduce((a, b) => a + b, 0) / frameRates.length;
        }

        // Debug functions
        function addDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            debugInfo.appendChild(entry);

            // Scroll to bottom
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        function forceEnableButtons() {
            document.getElementById('startColorBtn').disabled = false;
            document.getElementById('startDepthBtn').disabled = false;
            document.getElementById('stopStreamBtn').disabled = false;
            addDebugInfo('Buttons forcibly enabled');
        }

        function clearDebugInfo() {
            document.getElementById('debugInfo').innerHTML = '';
        }

        // Initialize Kinect
        window.initializeKinect = async function () {
            document.getElementById('streamStatus').textContent = 'Initializing Kinect...';
            addDebugInfo('Initializing Kinect...');

            try {
                // Initialize Kinect on the server using Promise-based approach
                addDebugInfo('Calling kinectron.initKinect()');
                const result = await kinectron.initKinect();

                addDebugInfo(`Kinect initialization result: ${JSON.stringify(result)}`);

                // Log button states before update
                const startBtnBefore = document.getElementById('startColorBtn').disabled;
                const stopBtnBefore = document.getElementById('stopStreamBtn').disabled;
                addDebugInfo(`Button states before update: startColorBtn=${startBtnBefore}, stopStreamBtn=${stopBtnBefore}`);

                // Check for success in the normalized result
                if (result.success || result.alreadyInitialized) {
                    addDebugInfo('Kinect initialized successfully - enabling buttons');
                    document.getElementById('streamStatus').innerHTML =
                        `<span class="success">Kinect ${result.alreadyInitialized ? 'Already' : ''} Initialized Successfully</span>`;

                    // Enable the buttons
                    document.getElementById('startColorBtn').disabled = false;
                    document.getElementById('startDepthBtn').disabled = false;
                    document.getElementById('stopStreamBtn').disabled = false;
                } else {
                    addDebugInfo(`Kinect initialization failed: ${result.error || 'Unknown error'}`);
                    document.getElementById('streamStatus').innerHTML =
                        `<span class="error">Kinect Initialization Failed: ${result.error || 'Unknown error'}</span>`;
                }

                // Log button states after update
                const startBtnAfter = document.getElementById('startColorBtn').disabled;
                const stopBtnAfter = document.getElementById('stopStreamBtn').disabled;
                addDebugInfo(`Button states after update: startColorBtn=${startBtnAfter}, stopStreamBtn=${stopBtnAfter}`);

                // Try to force enable buttons if they're still disabled
                if (startBtnAfter || stopBtnAfter) {
                    addDebugInfo('Buttons still disabled after update, forcing enable...');
                    forceEnableButtons();
                }
            } catch (error) {
                addDebugInfo(`Error initializing Kinect: ${error.message || 'Unknown error'}`);
                document.getElementById('streamStatus').innerHTML =
                    `<span class="error">Kinect Initialization Failed: ${error.message || 'Unknown error'}</span>`;
            }
        }

        // Start color stream
        window.startColorStream = function () {
            document.getElementById('streamStatus').textContent = 'Stream Status: Starting...';
            frameCount = 0;
            lastFrameTime = Date.now();
            frameRates = [];
            frameLatencies = [];
            isStreamActive = true;

            kinectron.startColor((frame) => {
                // Log frame data for debugging
                addDebugInfo(`Received color frame: width=${frame.width}, height=${frame.height}, timestamp=${frame.timestamp}`);

                // Update stream status
                document.getElementById('streamStatus').innerHTML =
                    '<span class="success">Stream Status: Active (Color)</span>';

                // Calculate frame metrics
                frameCount++;
                const now = Date.now();

                // Calculate frame rate every second
                if (now - lastFrameTime >= 1000) {
                    const fps = frameCount / ((now - lastFrameTime) / 1000);
                    frameRates.push(fps);
                    if (frameRates.length > 10) frameRates.shift(); // Keep last 10 readings
                    frameCount = 0;
                    lastFrameTime = now;
                }

                // Calculate frame latency
                if (frame.timestamp) {
                    const latency = now - frame.timestamp;
                    frameLatencies.push(latency);
                    addDebugInfo(`Frame latency: ${latency}ms`);
                }

                // Track last frame timestamp for jitter calculation
                lastFrameTimestamp = now;

                // Use p5.js loadImage to handle the frame data
                loadImage(frame.src, (loadedImage) => {
                    // Clear canvas
                    background(255);
                    // Draw the image
                    image(loadedImage, 0, 0, width, height);
                    addDebugInfo(`Image drawn to canvas: ${loadedImage.width}x${loadedImage.height}`);
                });
            });
        }

        // Start depth stream
        window.startDepthStream = function () {
            document.getElementById('streamStatus').textContent = 'Stream Status: Starting...';
            frameCount = 0;
            lastFrameTime = Date.now();
            frameRates = [];
            frameLatencies = [];
            isStreamActive = true;

            // Resize canvas for depth stream
            resizeCanvas(AZURE_DEPTH_WIDTH * DISPLAY_SCALE, AZURE_DEPTH_HEIGHT * DISPLAY_SCALE);
            background(255);

            addDebugInfo('Calling kinectron.startDepth()');
            kinectron.startDepth((frame) => {
                // Log frame data for debugging
                addDebugInfo(`Received depth frame: width=${frame.width}, height=${frame.height}, timestamp=${frame.timestamp}`);
                addDebugInfo(`Frame src type: ${typeof frame.src}, starts with: ${frame.src ? frame.src.substring(0, 30) + '...' : 'undefined'}`);
                addDebugInfo(`Frame raw data: ${JSON.stringify(frame.raw).substring(0, 100)}...`);

                // Update stream status
                document.getElementById('streamStatus').innerHTML =
                    '<span class="success">Stream Status: Active (Depth)</span>';

                // Calculate frame metrics
                frameCount++;
                const now = Date.now();

                // Calculate frame rate every second
                if (now - lastFrameTime >= 1000) {
                    const fps = frameCount / ((now - lastFrameTime) / 1000);
                    frameRates.push(fps);
                    if (frameRates.length > 10) frameRates.shift(); // Keep last 10 readings
                    frameCount = 0;
                    lastFrameTime = now;
                }

                // Calculate frame latency
                if (frame.timestamp) {
                    const latency = now - frame.timestamp;
                    frameLatencies.push(latency);
                    addDebugInfo(`Frame latency: ${latency}ms`);
                }

                // Track last frame timestamp for jitter calculation
                lastFrameTimestamp = now;

                // Use p5.js loadImage to handle the frame data
                if (frame.src) {
                    addDebugInfo('Loading image from frame.src');
                    loadImage(frame.src,
                        (loadedImage) => {
                            // Clear canvas
                            background(255);
                            // Draw the image
                            image(loadedImage, 0, 0, width, height);
                            addDebugInfo(`Image drawn to canvas: ${loadedImage.width}x${loadedImage.height}`);
                        },
                        (err) => {
                            addDebugInfo(`Error loading image: ${err}`);
                        }
                    );
                } else {
                    addDebugInfo('No frame.src available to load image');
                }
            });
        }

        // Stop all streams
        window.stopStream = function () {
            kinectron.stopAll();
            document.getElementById('streamStatus').textContent = 'Stream Status: Inactive';
            document.getElementById('frameRate').textContent = 'Frame Rate: 0 fps';
            document.getElementById('resolution').textContent = 'Resolution: -';
            background(255);
            isStreamActive = false;
        }
    </script>
</body>

</html>